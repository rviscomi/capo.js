(()=>{function e(e,t,i,s){Object.defineProperty(e,t,{get:i,set:s,enumerable:!0,configurable:!0})}function t(e){return[`oklch(5% .1 ${e})`,`oklch(13% .2 ${e})`,`oklch(25% .2 ${e})`,`oklch(35% .25 ${e})`,`oklch(50% .27 ${e})`,`oklch(67% .31 ${e})`,`oklch(72% .25 ${e})`,`oklch(80% .2 ${e})`,`oklch(90% .1 ${e})`,`oklch(99% .05 ${e})`,"#ccc"]}let i=["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2","#cccccc"],s=t(320),n=t(200),o={DEFAULT:i,PINK:s,BLUE:n};var a={};e(a,"IO",()=>r);class r{constructor(e,t,i=window.console){this.document=e,this.options=t,this.console=i,this.isStaticHead=!1,this.head=null}async init(){if(!this.head){if(this.options.prefersDynamicAssessment()){this.head=this.document.querySelector("head");return}try{let e=await this.getStaticHTML();e=e.replace(/(\<\/?)(head)/gi,"$1static-head");let t=this.document.implementation.createHTMLDocument("New Document");t.documentElement.innerHTML=e,this.head=t.querySelector("static-head"),this.head?this.isStaticHead=!0:this.head=this.document.head}catch(e){this.console.error(`${this.options.loggingPrefix}An exception occurred while getting the static <head>:`,e),this.head=this.document.head}this.isStaticHead||this.console.warn(`${this.options.loggingPrefix}Unable to parse the static (server-rendered) <head>. Falling back to document.head`,this.head)}}async getStaticHTML(){let e=this.document.location.href,t=await fetch(e);return await t.text()}getHead(){return this.head}stringifyElement(e){return e.getAttributeNames().reduce((t,i)=>t+=`[${CSS.escape(i)}=${JSON.stringify(e.getAttribute(i))}]`,e.nodeName)}getLoggableElement(e){if(!this.isStaticHead)return e;let t=this.stringifyElement(e),i=Array.from(this.document.head.querySelectorAll(t));if(0==i.length)return e;if(1==i.length)return i[0];let s=this.document.createElement("div"),n=this.document.createElement("div");n.innerHTML=e.innerHTML;let o=i.find(e=>(s.innerHTML=e.innerHTML,s.innerHTML==n.innerHTML));return o||e}createElementFromSelector(e){let t=e.match(/^[A-Za-z]+/)[0];if(!t)return;let i=document.createElement(t),s=e.match(/\[([A-Za-z-]+)="([^"]+)"\]/g)||[];return s.forEach(e=>{e=e.slice(1,-1);let t=e.indexOf("="),s=e.slice(0,t),n=e.slice(t+1).slice(1,-1);i.setAttribute(s,n)}),i}logElementFromSelector({weight:e,selector:t,innerHTML:i,isValid:s,customValidations:n={}}){e=+e;let o=this.getElementVisualization(e,s),a=this.createElementFromSelector(t);a.innerHTML=i,a=this.getLoggableElement(a),this.logElement({viz:o,weight:e,element:a,isValid:s,customValidations:n})}logElement({viz:e,weight:t,element:i,isValid:s,customValidations:n={},omitPrefix:o=!1}){o||(e.visual=`${this.options.loggingPrefix}${e.visual}`);let a="log",r=[e.visual,e.style,t+1,i];if(!this.options.isValidationEnabled()){this.console[a](...r);return}let{payload:l,warnings:c}=n;l&&("string"==typeof l.expiry&&(l.expiry=new Date(l.expiry)),r.push(l)),c?.length?(a="warn",r.push("\n"+c.map(e=>`  ❌ ${e}`).join("\n"))):!s&&(this.options.prefersDynamicAssessment()||this.isStaticHead)&&(a="warn",r.push(`
  ❌ invalid element (${i.tagName})`)),this.console[a](...r)}logValidationWarnings(e){this.options.isValidationEnabled()&&e.forEach(({warning:e,elements:t=[],element:i})=>{t=t.map(this.getLoggableElement.bind(this)),this.console.warn(`${this.options.loggingPrefix}${e}`,...t,i||"")})}getColor(e){return this.options.palette[10-e]}getHeadVisualization(e){let t="",i=[];return e.forEach(({weight:e,isValid:s})=>{t+="%c ";let n=this.getColor(e),o="padding: 5px; margin: 0 -1px; ";if(s)o+=`background-color: ${n};`;else{let e;o+=`background-image: ${n==(e="#cccccc")&&(e="red"),`repeating-linear-gradient(45deg, ${n}, ${n} 3px, ${e} 3px, ${e} 6px)`}`}i.push(o)}),{visual:t,styles:i}}getElementVisualization(e,t=!0){let i=`%c${Array(e+1).fill("█").join("")}`,s=this.getColor(e);return{visual:i,style:`color: ${s}`}}visualizeHead(e,t,i){let s=this.getHeadVisualization(i);this.console.groupCollapsed(`${this.options.loggingPrefix}${e} %chead%c order
${s.visual}`,"font-family: monospace","font-family: inherit",...s.styles),i.forEach(({weight:e,element:t,isValid:i,customValidations:s})=>{let n=this.getElementVisualization(e,i);this.logElement({viz:n,weight:e,element:t,isValid:i,customValidations:s,omitPrefix:!0})}),this.console.log(`${e} %chead%c element`,"font-family: monospace","font-family: inherit",t),this.console.groupEnd()}}var l={};e(l,"Options",()=>c);class c{constructor({preferredAssessmentMode:e=c.AssessmentMode.STATIC,validation:t=!0,palette:s=i,loggingPrefix:n="Capo: "}={}){this.setPreferredAssessmentMode(e),this.setValidation(t),this.setPalette(s),this.setLoggingPrefix(n)}static get AssessmentMode(){return{STATIC:"static",DYNAMIC:"dynamic"}}static get Palettes(){return o}prefersStaticAssessment(){return this.preferredAssessmentMode===c.AssessmentMode.STATIC}prefersDynamicAssessment(){return this.preferredAssessmentMode===c.AssessmentMode.DYNAMIC}isValidationEnabled(){return this.validation}setPreferredAssessmentMode(e){if(!this.isValidAssessmentMode(e))throw Error(`Invalid option: preferred assessment mode, expected AssessmentMode.STATIC or AssessmentMode.DYNAMIC, got "${e}".`);this.preferredAssessmentMode=e}setPreferredAssessmentModeToStatic(e){let t=c.AssessmentMode.STATIC;e||(t=c.AssessmentMode.DYNAMIC),this.setPreferredAssessmentMode(t)}setValidation(e){if(!this.isValidValidation(e))throw Error(`Invalid option: validation, expected boolean, got "${e}".`);this.validation=e}setPalette(e){if(!this.isValidPalette(e))throw Error(`Invalid option: palette, expected [${Object.keys(o).join("|")}] or an array of colors, got "${e}".`);if("string"==typeof e){this.palette=o[e];return}this.palette=e}setLoggingPrefix(e){if(!this.isValidLoggingPrefix(e))throw Error(`Invalid option: logging prefix, expected string, got "${e}".`);this.loggingPrefix=e}isValidAssessmentMode(e){return Object.values(c.AssessmentMode).includes(e)}isValidValidation(e){return"boolean"==typeof e}isValidPalette(e){return"string"==typeof e?Object.keys(o).includes(e):!!Array.isArray(e)&&11===e.length&&e.every(e=>"string"==typeof e)}isValidLoggingPrefix(e){return"string"==typeof e}isPreferredPalette(e){return JSON.stringify(this.palette)==JSON.stringify(e)}valueOf(){return{preferredAssessmentMode:this.preferredAssessmentMode,validation:this.validation,palette:this.palette,loggingPrefix:this.loggingPrefix}}}async function d(e){await e.init();let t=logging.logAnalysis(e);return{actual:t.map(({element:t,weight:i,isValid:s,customValidations:n})=>(n?.payload?.expiry&&(n.payload.expiry=n.payload.expiry.toString()),{weight:i,color:e.getColor(i),selector:e.stringifyElement(t),innerHTML:t.innerHTML,isValid:s,customValidations:n}))}}async function h(){let{options:e}=await chrome.storage.sync.get("options");return new l.Options(e)}!async function(){let e=await h(),t=new a.IO(document,e),{click:i}=await chrome.storage.local.get("click");if(i)t.logElementFromSelector(JSON.parse(i)),await chrome.storage.local.remove("click");else{let e=await d(t);await chrome.storage.local.set({data:e})}}()})();